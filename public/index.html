<!DOCTYPE html>
<html>

<head>
	<title>Lancer BASE</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"
		integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
		integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
		crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
		integrity="sha384-4LISF5TTJX/fLmGSxO53rV4miRxdg84mZsxmO8Rx5jGtp/LbrixFETvWa5a6sESd" crossorigin="anonymous">
	<link rel="stylesheet" href="/css/styles.css">
</head>
<body>

	<!-- Sticky top bar for resources -->
	<div id="resources-bar">
		Loading...
	</div>

	<!-- Header -->
	<header class="bannerimg" id="home">
		<div class="main-title">
			<span>Lancer<br>BASE</span>
		</div>
	</header>

	<!-- Main page container -->
	<div class="bgfullimg">
		<div class="container">
			<!-- Status -->
			<div class="row">
				<div id="condition-bar" class="col-md-4">
					Loading...
				</div>
				<div id="morale-bar" class="col-md-4">
					Loading...
				</div>
				<div class="col-md-4">
					<span class="condition-text">Pilot: </span>
					<select id="pilot-select" class="base-select"></select>
				</div>
			</div>

			<!-- Stats -->
			<div class="row" id="defense-container">
				Loading...
			</div>

			<!-- Facilities -->
			<div class="row">
				<div class="col-md-12 info-container">
					<div class="row">
						<div class="col-md-4">
							<span class="addon-header">Facilities</span>
						</div>
						<div class="col-md-2 offset-md-6" style="margin-top: 8px;">
							<button type="button" class="addon-header-button base-btn" data-bs-toggle="modal"
								data-bs-target="#facilities-modal">
								Build
							</button>
						</div>
					</div>
					<div id="facilities-container" class="row">

					</div>
				</div>
			</div>
			<div class="modal modal-xl fade" id="facilities-modal" tabindex="-1" aria-labelledby="facilities-modal-label"
				aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h1 class="modal-title fs-5" id="facilities-modal-label">Build Facilities</h1>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<div id="facilities-build-container" class="row">
								Loading...
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="base-btn" data-bs-dismiss="modal">Close</button>
							<button type="button" class="btn-modal-confirm base-btn buy-addon-btn" data-bs-dismiss="modal"
								disabled>Build</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Defenses -->
			<div class="row">
				<div class="col-md-12 info-container">
					<div class="row">
						<div class="col-md-4">
							<span class="addon-header">Defenses</span>
						</div>
						<div class="col-md-2 offset-md-6" style="margin-top: 8px;">
							<button type="button" class="addon-header-button base-btn" data-bs-toggle="modal"
								data-bs-target="#defenses-modal">
								Build
							</button>
						</div>
						<div id="defenses-container" class="row">
							Loading...
						</div>
					</div>
				</div>
			</div>
			<div class="modal modal-xl fade" id="defenses-modal" tabindex="-1" aria-labelledby="defenses-modal-label"
				aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h1 class="modal-title fs-5" id="defenses-modal-label">Build Defenses</h1>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<div id="defenses-build-container" class="row">
								Loading...
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="base-btn" data-bs-dismiss="modal">Close</button>
							<button type="button" class="btn-modal-confirm base-btn buy-addon-btn" data-bs-dismiss="modal"
								disabled>Build</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Personnel -->
			<div class="row">
				<div class="col-md-12 info-container">
					<div class="row">
						<div class="col-md-4">
							<span class="addon-header">Personnel</span>
						</div>
						<div class="col-md-2 offset-md-6" style="margin-top: 8px;">
							<button type="button" class="addon-header-button base-btn" data-bs-toggle="modal"
								data-bs-target="#personnel-modal">
								Recruit
							</button>
						</div>
						<div id="personnel-container" class="row">
							Loading...
						</div>
					</div>
				</div>
			</div>
			<div class="modal modal-xl fade" id="personnel-modal" tabindex="-1" aria-labelledby="personnel-modal-label"
				aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h1 class="modal-title fs-5" id="personnel-modal-label">Recruit Personnel</h1>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<div id="personnel-recruit-container" class="row">
								Lodaing...
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="base-btn" data-bs-dismiss="modal">Close</button>
							<button type="button" class="btn-modal-confirm base-btn buy-addon-btn" data-bs-dismiss="modal"
								disabled>Recruit</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Logs -->
			<div class="row">
				<div class="col-md-12 info-container">
					<div class="row">
						<div class="col-md-4">
							<span class="addon-header">Logs</span>
						</div>
						<div class="col-md-2 offset-md-6" style="margin-top: 8px;">
						</div>
						<div id="log-container" class="row">
							Loading...
						</div>
					</div>
				</div>
			</div>

		</div>
	</div>

	<!-- HandleBars Templates -->
	<script id="logTemplate" type="text/x-handlebars-template">
		<ol>
			{{#each logs}}
				<li>
					<span>[{{ user }}]</span> - {{ message }}
				</li>
			{{/each}}
		</ol>
	</script>
	<script id="defenseTemplate" type="text/x-handlebars-template">
		{{#each defenses}}
			<div class="col-md-4">
				<span class="stats-text">{{ name }}: {{value}}</span>
			</div>
		{{/each}}
	</script>
	<script id="upgradeTemplate" type="text/x-handlebars-template">
		{{#each upgrades}}
			<div class="col-md-3">
				<div class="addon-item selectable">
					<div class="addon-name">
						{{ name }}
					</div>
					<div class="addon-costs">
						{{#if cost.materials}}
							<span class="addon-cost-item">
								<i class="bi bi-boxes"></i>
								{{cost.materials}}
							</span>
						{{/if}}
						{{#if cost.refinedMaterials}}
							<span class="addon-cost-item">
								<i class="bi bi-device-ssd"></i>
								{{cost.refinedMaterials}}
							</span>
						{{/if}}
						{{#if cost.manna}}
						<span class="addon-cost-item">
							<i class="bi bi-currency-bitcoin"></i>
							{{cost.manna}}
						</span>
						{{/if}}
					</div>
					<div>
						{{description}}
					</div>
					<div>
						{{notes}}
					</div>
				</div>
			</div>
		{{/each}}
	</script>
	<script id="addonsTemplate" type="text/x-handlebars-template">
		{{#each addons}}
		<div class="col-md-3">
			<div class="addon-item">
				<div class="addon-name">{{name}}</div>
				<div class="addon-description">{{description}}</div>
				<div class="addon-notes">{{notes}}</div>
				<div class="addon-construction-controls">
					<div class="addon-construction-sign">UNDER CONSTRUCTION</div>
					<div class="addon-construction-time">Work Remaining: {{timeRemaining}}</div>
					<button class="base-btn work-addon-btn">Add Work</button>
				</div>
			</div>
		</div>
		{{/each}}
	</script>
	<script id="resourcesTemplate" type="text/x-handlebars-template">
		<div class="row">
			<div class="col-md-4">
				<i class="bi bi-boxes"></i>
				<span>Materials: {{resources.materials.quantity}}</span>
			</div>
			<div class="col-md-4">
				<i class="bi bi-device-ssd"></i>
				<span>Refined Materials: {{resources.refinedMaterials.quantity}}</span>
			</div>
			<div class="col-md-4">
				<i class="bi bi-currency-bitcoin"></i>
				<span>Manna: {{resources.manna.quantity}}</span>
			</div>
		</div>
	</script>
	<script id="statusBarTemplate" type="text/x-handlebars-template">
		<span class="status-bar-label">{{label}}: </span>
		<div class="status-bar" style="{{styles}}">
			<div class="status-bar-fill">{{value}}/{{maxValue}}</div>
		</div>
	</script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.8/handlebars.min.js" integrity="sha512-E1dSFxg+wsfJ4HKjutk/WaCzK7S2wv1POn1RRPGh8ZK+ag9l244Vqxji3r6wgz9YBf6+vhQEYJZpSjqWFPg9gg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script>
		const deselectAll = () => {
			$('.selectable.selected')
				.closest('.modal-content')
				.find('.btn-modal-confirm')
				.prop('disabled', true);
			$('.selectable.selected')
				.removeClass('selected');
		}

		const addAddon = (addon, containerSelector) => {
			let extraClasses = '';
			let timeRemaining = 0;
			if ('timeRemaining' in addon && addon['timeRemaining'] > 0) {
				extraClasses += 'under-construction ';
				timeRemaining = addon['timeRemaining'];
			}
			$(containerSelector).append(
				'<div class="col-md-3"><div class="addon-item ' + extraClasses + '">' +
				'<div class="addon-name">' + addon['name'] + '</div>' +
				'<div class="addon-description">' + addon['description'] + '</div>' +
				'<div class="addon-notes">' + addon['notes'] + '</div>' +
				'<div class="addon-construction-controls">' +
				'<div class="addon-construction-sign">UNDER CONSTRUCTION' + '</div>' +
				'<div class="addon-construction-time">Work Remaining: ' + timeRemaining + '</div>' +
				'<button class="base-btn work-addon-btn">Add Work</button>' +
				'</div>' +
				'</div></div>'
			);
			$(containerSelector).find('.addon-item').last().data('addon', addon);

		};

		/**************** Event handlers ***************/
		$('.buy-addon-btn').click(async (e) => {
			if ($(this).attr('disabled')) {
				return;
			}

			//Update addon
			const addon = $('.addon-item.selected').data('addon');

			// Update resources
			var currentResources = {
				"materials": $('#resources-materials').data('quantity'),
				"refinedMaterials": $('#resources-r-materials').data('quantity'),
				"manna": $('#resources-manna').data('quantity')
			};
			let addonCosts = addon['cost'];
			let newResources = {
				"materials": {
					"name": "Materials",
					"quantity": currentResources['materials'] - addonCosts['materials']
				},
				"refinedMaterials": {
					"name": "Refined Materials",
					"quantity": currentResources['refinedMaterials'] - addonCosts['refinedMaterials']
				},
				"manna": {
					"name": "Manna",
					"quantity": currentResources['manna'] - addonCosts['manna']
				}
			};

			try {
				const response = await fetch('/update/base', {
					method: "POST",
					body: JSON.stringify({
						action: 'buyAddon',
						resources: newResources,
						addon,
						pilot: $('#pilot-select').val()
					}),
					headers: {
						"Content-type": "application/json; charset=UTF-8"
					}
				});
				const baseData = await response.json();
				// updateBaseStats(baseData['newBase']); TODO update global state and rerender
				// updateAddons(baseData['newBase']);
			} catch (err) {
				console.error(`Error: ${err}`);
			}

			//Update page data. Yes I should probably be storing a main data object and refreshing the page from that. 
			// updateResources(newResources);
			if (addon['family'] == 'facilities') {
				addFacility(addon);
			} else if (addon['family'] == 'defenses') {
				addDefense(addon);
			} else if (addon['family'] == 'personnel') {
				addPersonnel(addon);
			}

			//Remove the addon from the build menu
			$('.addon-item.selected').remove();
		});

		function renderLogs(logs) {
			const source = document.getElementById('logTemplate').innerHTML;
			const template = Handlebars.compile(source);
			const rendered = template({ logs });
			document.getElementById('log-container').innerHTML = rendered;
		}

		function renderDefenses(defenses) {
			const source = document.getElementById('defenseTemplate').innerHTML;
			const template = Handlebars.compile(source);
			const rendered = template({ defenses });
			document.getElementById('defense-container').innerHTML = rendered;
		}

		function renderUpgrades(upgrades, containerId) {
			const source = document.getElementById('upgradeTemplate').innerHTML;
			const template = Handlebars.compile(source);
			const rendered = template({ upgrades });
			document.getElementById(containerId).innerHTML = rendered;
		}

		function renderAddons(addons, containerId) {
			const source = document.getElementById('addonsTemplate').innerHTML;
			const template = Handlebars.compile(source);
			const rendered = template({ addons });
			document.getElementById(containerId).innerHTML = rendered;
		}

		function renderResources(resources) {
			const source = document.getElementById('resourcesTemplate').innerHTML;
			const template = Handlebars.compile(source);
			const rendered = template({ resources });
			document.getElementById('resources-bar').innerHTML = rendered;
		}

		function renderStatusBar(label, value, maxValue, containerId) {
			const percentage = (value/maxValue) * 100;
			let barColour = 'red'
			if (percentage > 65) {
				barColour = '#2196F3';
			} else if (percentage >25) {
				barColour = 'yellow';
			}

			const styles = `background: linear-gradient(to right, ${barColour} ${percentage}%, white ${percentage}%)`;
			const source = document.getElementById('statusBarTemplate').innerHTML;
			const template = Handlebars.compile(source);
			const rendered = template({ label, value, maxValue, styles });
			document.getElementById(containerId).innerHTML = rendered;
		}
	
	</script>
	<script>
		this.state = {};

		async function init() {
			// Load Base data
			try {
				const response = await fetch('./data/baseData');
				const baseData = await response.json();
				this.state = baseData;

				// Generates the stats for the base from all the addons (might be a bit convoluted)
				const [
					defense, 
					eDefense, 
					sensors
				] = [
					...baseData.facilities,
					...baseData.defenses,
					...baseData.personnel,
				].reduce((acc, addon) => {

					acc[0] += addon.defense || 0;
					acc[1] += addon.eDefense || 0;
					acc[2] += addon.sensors || 0;

					return acc;
				}, [
					baseData.defense,
					baseData.eDefense,
					baseData.sensors
				]);

				this.state.stats = [
					{name: "Defense", value: defense},
					{name: "E-Defense", value: eDefense},
					{name: "Sensors", value: sensors}
				];

			} catch (err) {
				console.error(`Error: ${err}`);
			}
			
			// Load log data
			try {
				const response = await fetch(`./log`);
				this.state.logs = await response.json();
			} catch (err) {
				console.error(`Error: ${err}`);
			}

			// Load Pilot data
			try {
				const response = await fetch('./data/pilotData');
				this.state.pilots = await response.json();
			} catch (err) {
				console.error(`Error: ${err}`);
			}

			// Load Upgrade data
			try {
				const response = await fetch('./data/upgrades.json');
				const upgrades = await response.json();

				this.state.upgrades = {
					personnel: upgrades.personnel.filter((recruit) => recruit.available > 0),
					defenses: upgrades.defenses.filter((defense) => defense.available > 0),
					facilities: upgrades.facilities.filter((facility) => facility.available > 0)
				};

			} catch (err) {
				console.error(`Error: ${err}`);
			}

			render();
		}

		function render() {
			renderLogs(this.state.logs);
			
			//Populate pilot dropdown
			this.state.pilots?.map((pilot) => {
				$('#pilot-select').append(`<option value="${pilot}">${pilot}</option>`);
			});
			
			renderDefenses(this.state.stats);
			renderResources(this.state.resources);
			
			renderStatusBar('Condition', this.state.condition, this.state.conditionMax, 'condition-bar');
			renderStatusBar('Morale', this.state.morale, this.state.moraleMax, 'morale-bar');
			
			renderUpgrades(this.state.facilities, 'facilities-container');
			renderUpgrades(this.state.defenses, 'defenses-container');
			renderUpgrades(this.state.personnel, 'personnel-container');

			renderAddons(this.state.upgrades.facilities,'facilities-build-container');
			renderAddons(this.state.upgrades.defenses, 'defenses-build-container');
			renderAddons(this.state.upgrades.personnel, 'personnel-recruit-container');

			/*** Addon interation code ***/
			$('.addon-item.selectable').click(function () {
				deselectAll();

				var costs = $(this).data('addon')['cost'];

				$(this).addClass('selected');
				var affordable = true;
				for (const [name, value] of Object.entries(this.state.resources)) {
					if (value < costs[name]) {
						affordable = false;
						break;
					}
				}

				if (affordable) {
					$(this).closest('.modal-content').find('.btn-modal-confirm').prop('disabled', false);
				}
			});

			$('.btn-close').click(function () {
				deselectAll();
			});

			$('.work-addon-btn').click(async function () {
				if ($(this).attr('disabled')) {
					return;
				}
				console.log('clicked, sending to server')
				//Update addon
				const addon = $(this).closest('.addon-item').data('addon');
				try {
					const response = await fetch('/update/base', {
						method: "POST",
						body: JSON.stringify({
							action: 'workAddon',
							addon: addon,
							pilot: $('#pilot-select').val()
						}),
						headers: {
							"Content-type": "application/json; charset=UTF-8"
						}
					});
					const data = await response.json();
					// updateAddons(data['newBase']);
				} catch (err) {
					console.error(`Error: ${err}`);
				}
			});
		}

		init();
	</script>
</body>
</html>